---
title: "ACC Spectrogram"
output: html_document
date: "2022-11-10"
---

# load libraries
```{r}
library(pacman)
p_load(tidyverse, magrittr, dplyr, plyr, data.table,
       lubridate, janitor, ggplot2,
       av, seewave, tuneR, phonTools, soundgen # acoustic analysis
       )
```


```{r}
# https://lukemiller.org/index.php/2011/02/converting-matlab-and-r-date-and-time-values/
matlab2POS = function(x, timez = "UTC") {
	days = x - 719529 	# 719529 = days from 1-1-0000 to 1-1-1970
	secs = days * 86400 # 86400 seconds in a day
	# This next string of functions is a complete disaster, but it works.
	# It tries to outsmart R by converting the secs value to a POSIXct value
	# in the UTC time zone, then converts that to a time/date string that 
	# should lose the time zone, and then it performs a second as.POSIXct()
	# conversion on the time/date string to get a POSIXct value in the user's 
	# specified timezone. Time zones are a goddamned nightmare.
	return(format(as.POSIXct(secs, origin = '1970-1-1', tz = 'UTC'), '%Y-%m-%d %H:%M:%OS3'))
}
```


# create wave
## P. hastatus

```{r}
bats <- list.dirs("../../../../ownCloud/Firetail/Model_7CE02AF_main")
k = 1
for(k in 2:length(bats)){
  files <- list.files(bats[k], full.names = TRUE, 
                    pattern = "*-annotated-bursts-gps.csv")
  df <- fread(files[1])
  # df$timestamp %>% ymd_hms %>% date %>% table
  dates <- df$timestamp %>% ymd_hms %>% date %>% unique
  j = 3
  for(j in 1:length(dates)){
    d <- df[which(date(ymd_hms(df$timestamp)) == dates[j]),]
    x <- {}
    y <- {}
    z <- {}
    time <- {}
    burst <- {}
    i = 100
    b = 1
    if(nrow(d) > 1000){
      for(i in 1:nrow(d)){
        temp <- {}
        temp <- d$eobs_accelerations_raw[i] %>% strsplit(" ") %>% 
          unlist %>% 
          as.numeric
        d$resting %>% nchar
        if(length(temp) > 0 & nchar(d$resting[i]) == 0 & nchar(d$foraging[i]) == 0){
          x <- c(x, temp[seq(1, length(temp), 3)])
          y <- c(y, temp[seq(2, length(temp), 3)])
          z <- c(z, temp[seq(3, length(temp), 3)])
          temp_time <- seq.POSIXt(from = d$timestamp[i], 
                                   to = d$timestamp[i]+length(temp)/25/3, 
                                   length.out = length(temp)/3)
          time <- c(time, format(temp_time, "%Y-%m-%d %H:%M:%OS2") %>% as.character)
          burst <- c(burst, rep(b, length(temp)))
        }
        if(nchar(d$resting[i] > 0 | nchar(d$foraging[i]) > 0)){b = b + 1}
      }
    png(filename = paste0(bats[k],"/",dates[j],"_z_by_time.png"))
      plot(ymd_hms(time), z, type = "o", col = burst)
    dev.off()
    w <- Wave(left = z, samp.rate = 25, bit = 16)
    # plot(w)
    # spectro(w)
    wf <- ffilter(w, f= 25, from = 5, to = 7, bandpass = TRUE)
    png(filename = paste0(bats[k],"/",dates[j],"_wingbeatfreq.png"))
      spectro(wf, f = 25, wl = 1024*2)
      par(new=TRUE)
      pf <- dfreq(wf, f=25,wl = 1024*2, ovlp=50, threshold=20, type="l", col="red", lwd=2, xlab = "", ylab = "")  
    dev.off()
    save(x,y,z,time,burst,w,wf,pf, file = paste0(bats[k],"/",dates[j],"_wingbeatfreq.robj"))
    }
  }
}


```

## M. vivesi
```{r}
bats <- list.files("../../../../Dropbox/VivesiACC/data/", recursive = FALSE, pattern = "*.csv", full.names = TRUE)
k = 24
for(k in 1:length(bats)){
  df <- fread(bats[k])
  # df$timestamp %>% ymd_hms %>% date %>% table
  if(length(df$time) == 0){
    df$time <- matlab2POS(df$ACCtime)
  }
  dates <- df$time %>% ymd_hms %>% date %>% unique
  j = 1
  for(j in 1:length(dates)){
    d <- df[which(date(ymd_hms(df$time)) == dates[j]),]
    # png(filename = paste0(bats[k],"/",dates[j],"_z_by_time.png"))
      plot(ymd_hms(d$time), d$ACCZ, type = "l")
    # dev.off()
    sample_rate <- ifelse(year(d$time[1]) == 2017, 40, 50)
      
      w <- Wave(left = d$ACCZ, samp.rate = sample_rate, bit = 16)
      plot(w)
      spectro(w, f = sample_rate, flim = c(0,0.015))
      wf <- ffilter(w, f= sample_rate, from = 5, to = 10, bandpass = TRUE)
      # png(filename = paste0(bats[k],"/",dates[j],"_wingbeatfreq.png"))
        spectro(wf, f = sample_rate, wl = 1024*2)
        par(new=TRUE)
        pf <- dfreq(wf, f=sample_rate,wl = 1024*2, ovlp=50, threshold=20, 
                    type="l", col="red", lwd=1, xlab = "", ylab = "")  
      # dev.off()  
    }
    # save(x,y,z,time,burst,w,wf,pf,sample_rate, file = paste0(bats[k],"/",dates[j],"_wingbeatfreq.robj"))
    }
  }
}

print(df$ACCtime[1], digits = 21)
matlab2POS(df$ACCtime[1])
```

